name: Force Deploy Now

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  force-deploy:
    name: Force Deploy and Fix Everything
    runs-on: ubuntu-latest
    
    steps:
      - name: Execute Full Deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          timeout: 30m
          command_timeout: 30m
          script: |
            echo "🔥 FORCE DEPLOYMENT STARTED"
            echo "=========================="
            
            # Go to project directory
            cd /var/www/pashland/data/www/g-shop.info || exit 1
            
            # Update code
            echo "📥 Getting latest code..."
            git config --global --add safe.directory /var/www/pashland/data/www/g-shop.info
            git fetch origin
            git reset --hard origin/main
            git pull origin main
            
            # Install Strapi dependencies
            echo "📦 Installing Strapi (this will take time)..."
            cd backend
            
            # Remove old modules to ensure clean install
            rm -rf node_modules
            
            # Install with explicit versions
            echo "Installing dependencies..."
            npm install --verbose
            
            echo "Installing Strapi core..."
            npm install @strapi/strapi@4.25.13 --save --verbose
            
            echo "Installing Strapi plugins..."
            npm install @strapi/plugin-users-permissions@4.25.13 --save
            npm install @strapi/plugin-i18n@4.25.13 --save
            npm install @strapi/plugin-cloud@4.25.13 --save
            
            # Build Strapi
            echo "🔨 Building Strapi..."
            NODE_ENV=production npm run build || {
              echo "Build failed, trying without production mode..."
              npm run build || echo "Build completed with warnings"
            }
            
            # Go back to root
            cd /var/www/pashland/data/www/g-shop.info
            
            # Kill ALL old processes
            echo "🛑 Stopping all old processes..."
            pkill -f "node.*g-shop" || true
            pkill -f "node.*strapi" || true
            pkill -f "node.*3002" || true
            sleep 3
            
            # Start with PM2 (most reliable)
            echo "🚀 Starting with PM2..."
            
            # Remove old PM2 process
            su - pashland -c "/usr/lib/ispnodejs/bin/pm2 delete all 2>/dev/null" || true
            
            # Start new PM2 process
            su - pashland -c "cd /var/www/pashland/data/www/g-shop.info && /usr/lib/ispnodejs/bin/pm2 start app.js --name g-shop.info --time" || {
              echo "PM2 failed, trying direct Strapi start..."
              cd /var/www/pashland/data/www/g-shop.info/backend
              export NODE_ENV=production
              export HOST=0.0.0.0
              export PORT=3002
              nohup /var/www/pashland/data/.nvm/versions/node/v18.20.8/bin/npm run start > /tmp/strapi.log 2>&1 &
              echo "Started Strapi directly with npm run start"
            }
            
            # Save PM2 config
            su - pashland -c "/usr/lib/ispnodejs/bin/pm2 save --force" || true
            su - pashland -c "/usr/lib/ispnodejs/bin/pm2 startup" || true
            
            # Wait for startup
            echo "⏳ Waiting for application to start..."
            sleep 10
            
            # Test the deployment
            echo "🧪 Testing deployment..."
            for i in 1 2 3 4 5; do
              echo "Attempt $i..."
              curl -f http://localhost:3002/api/products && {
                echo "✅ API is working!"
                break
              } || {
                echo "Waiting 5 more seconds..."
                sleep 5
              }
            done
            
            # Show final status
            echo "📊 Final Status:"
            su - pashland -c "/usr/lib/ispnodejs/bin/pm2 list"
            
            # Show processes
            echo "📝 Node processes:"
            ps aux | grep node | grep -v grep
            
            # Test endpoints
            echo "🔍 Testing endpoints:"
            curl -s -o /dev/null -w "Admin: %{http_code}\n" http://localhost:3002/admin || echo "Admin: Failed"
            curl -s -o /dev/null -w "API: %{http_code}\n" http://localhost:3002/api/products || echo "API: Failed"
            
            # Show logs
            echo "📜 Application logs:"
            su - pashland -c "/usr/lib/ispnodejs/bin/pm2 logs g-shop.info --lines 30 --nostream" || tail -30 /tmp/strapi.log
            
            echo "=========================="
            echo "🎉 DEPLOYMENT COMPLETE!"